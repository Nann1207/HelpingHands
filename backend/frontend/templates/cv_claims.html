<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CV · My Claims · Helping Hands</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

      <!-- Floating Chat Button -->
  <a href="/cv_chats/"
      class="fixed right-6 bottom-6 w-14 h-14 rounded-full bg-yellow-200 border flex items-center justify-center shadow">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 10h8M8 14h5M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
  </a>


  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-50 border-b bg-white/90 backdrop-blur">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/cv_dashboard/" class="font-semibold hover:underline">← Back to Dashboard</a>
      <form method="post" action="/api/auth/logout/" class="inline-block m-0 p-0">
        {% csrf_token %}
        <button type="submit" class="px-3 py-1.5 rounded-md bg-red-500 text-white hover:bg-red-600">
          Log out
        </button>
      </form>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <section class="rounded-xl border bg-white">
      <div class="p-3 border-b font-semibold">My Claims</div>
      <div id="claimList" class="p-3 grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>

    <section id="newClaimBox" class="rounded-xl border bg-white hidden">
      <div class="p-3 border-b font-semibold">New Claim</div>
      <form id="claimForm" class="p-3 grid grid-cols-1 md:grid-cols-2 gap-3" enctype="multipart/form-data">
        <div class="col-span-1">
          <label class="block text-sm text-gray-600 mb-1">Request ID</label>
          <input id="reqId" class="w-full border rounded-md px-3 py-2" readonly />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Category</label>
          <select name="category" class="w-full border rounded-md px-3 py-2">
            <option value="transport">Transportation</option>
            <option value="food">Food</option>
            <option value="meds">Medication</option>
            <option value="appointment">Appointment</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Expense Date</label>
          <input name="expense_date" type="date" class="w-full border rounded-md px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Amount</label>
          <input name="amount" type="number" step="0.01" class="w-full border rounded-md px-3 py-2" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Payment Method</label>
          <select name="payment_method" class="w-full border rounded-md px-3 py-2">
            <option value="cash">Cash</option>
            <option value="card">Card</option>
            <option value="paynow">Bank Paynow</option>
            <option value="paylah">DBS PayLah</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-600 mb-1">Description</label>
          <textarea name="description" class="w-full border rounded-md px-3 py-2" rows="3"></textarea>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-600 mb-1">Receipt (PDF/JPG/PNG)</label>
          <input name="receipt" type="file" class="w-full border rounded-md px-3 py-2" />
        </div>
        <div class="md:col-span-2">
          <button class="px-3 py-2 rounded-md bg-gray-900 text-white hover:bg-gray-800">Submit Claim</button>
        </div>
      </form>
    </section>
  </main>

  <script>
    function qs(s){return document.querySelector(s)}
    function getCSRF(){return document.cookie.split("; ").find(c=>c.startsWith("csrftoken="))?.split("=")[1] || "";}
    async function j(u,o){
      const opts = {credentials:"include", ...o};
      if(!opts.headers) opts.headers = {};
      if(!(opts.headers["X-CSRFToken"] || opts.headers["x-csrftoken"])) opts.headers["X-CSRFToken"] = getCSRF();
      const r=await fetch(u,opts);
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function badge(status){
      const map = {
        submitted: "bg-yellow-100 text-yellow-800",
        verified_by_pin: "bg-blue-100 text-blue-800",
        disputed_by_pin: "bg-red-100 text-red-800",
        reimbursed_by_csr: "bg-green-100 text-green-800",
        rejected_by_csr: "bg-gray-100 text-gray-700",
      };
      const cls = map[status] || "bg-gray-100 text-gray-700";
      return `<span class="text-xs px-2 py-0.5 rounded ${cls}">${status.replaceAll("_"," ")}</span>`;
    }

    function cardClaim(c){
      const url = c.receipt_url ? `<a class="text-sm text-gray-600 hover:underline" href="${c.receipt_url}" target="_blank">Receipt</a>` : "";
      return `
      <div class="p-4 border border-black rounded-xl bg-white">
        <div class="flex items-center justify-between">
          <div class="font-semibold">Req ${c.request_id}</div>
          ${badge(c.status)}
        </div>
        <div class="text-sm text-gray-700 mt-1">${c.category} · $${Number(c.amount).toFixed(2)}</div>
        <div class="text-xs text-gray-500">Date: ${c.expense_date}</div>
        <div class="mt-2">${url}</div>
      </div>`;
    }

    async function loadClaims(){
      const list = await j("/api/cv/claims/");
      qs("#claimList").innerHTML = (list||[]).map(cardClaim).join("") || `<div class="px-3 py-2 text-sm text-gray-500">No claims yet.</div>`;
    }

    function initNewClaim(){
      const url = new URL(location.href);
      const req = url.searchParams.get("newFor");
      if(!req) return;
      qs("#newClaimBox").classList.remove("hidden");
      qs("#reqId").value = req;

      const form = qs("#claimForm");
      form.addEventListener("submit", async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        try{
          const resp = await fetch(`/api/cv/requests/${req}/claims/`, {
            method:"POST",
            body: fd,
            credentials:"include",
            headers:{ "X-CSRFToken": getCSRF() }
          });
          if(!resp.ok) throw new Error(await resp.text());
          await loadClaims();
          alert("Claim submitted.");
          location.href = "/cv_claims/";
        }catch(e){ alert("Failed to submit claim."); }
      });
    }

    window.addEventListener("DOMContentLoaded", async ()=>{
      await loadClaims();
      initNewClaim();
    });
  </script>
</body>
</html>
