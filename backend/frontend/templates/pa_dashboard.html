<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PA Dashboard · Helping Hands</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* to lock chart panel height */
    #requestsChartWrap { height: 22rem; } /* ~ h-88 */
    #requestsChart { width: 100% !important; height: 100% !important; }
    code.api { font-size: 0.75rem; padding: 0.15rem 0.35rem; background: #f3f4f6; border-radius: 0.25rem; }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <!-- Top Bar -->
  <header class="sticky top-0 z-50 border-b bg-white/90 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/pa_dashboard/" class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 21S4 13.748 4 9A5 5 0 0 1 14 7a5 5 0 1 1 6 2c0 4.748-8 12-8 12z"/>
        </svg>
        <span class="text-xl font-bold">Helping Hands (Platform Admin)</span>
      </a>
      <nav class="flex items-center gap-3">
        <a href="/pa_flags/" class="px-3 py-1.5 rounded-md border hover:bg-gray-100">
          Flagged Requests
        </a>
        <form method="post" action="/api/auth/logout/" class="inline-block m-0 p-0">
          {% csrf_token %}
          <button type="submit" class="px-3 py-1.5 rounded-md bg-red-500 text-white hover:bg-red-600">
            Log out
          </button>
        </form>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <section class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold">Platform Admin Dashboard</h1>
        <p class="text-gray-600" id="whoami">Checking session…</p>
      </div>

      <!-- Export-->
      <div class="flex flex-wrap items-center gap-2">
        <a id="exportLink" href="#" class="px-3 py-2 rounded-md border hover:bg-gray-300">Export Request Statistics</a>
      </div>
    </section>

    <!-- KPI mini-cards -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
      
      <div class="p-6 border border-black rounded-2xl hover:shadow-xl transition-all duration-300 bg-white hover:scale-[1.02] text-center">
        <div class="text-sm font-bold text-gray-900 mb-2">Number of PINs</div>
        <div id="kpiPins" class="text-4xl font-extrabold text-gray-900 mb-1">—</div>
      </div>

      <div class="p-6 border border-black rounded-2xl hover:shadow-xl transition-all duration-300 bg-white hover:scale-[1.02] text-center">
        <div class="text-sm font-bold text-gray-900 mb-2">Number of CVs</div>
        <div id="kpiCVs" class="text-4xl font-extrabold text-gray-900 mb-1">—</div>
      </div>
      <div class="p-6 border border-black rounded-2xl hover:shadow-xl transition-all duration-300 bg-white hover:scale-[1.02] text-center">
        <div class="text-sm font-bold text-gray-900 mb-2">Number of CSR Reps</div>
        <div id="kpiCSRs" class="text-4xl font-extrabold text-gray-900 mb-1">—</div>
      </div>
      <div class="p-6 border border-black rounded-2xl hover:shadow-xl transition-all duration-300 bg-white hover:scale-[1.02] text-center">
        <div class="text-sm font-bold text-gray-900 mb-2">Open Flags</div>
        <div id="kpiOpenFlags" class="text-4xl font-extrabold text-gray-900 mb-1">—</div>
        <div class="text-xs text-gray-600">Resolved: <span id="kpiResolvedFlags">—</span></div>
      </div>
    </section>

    <!-- Requests status mini-cards -->
    <section class="grid grid-cols-2 md:grid-cols-5 gap-4">
      <div class="p-4 border border-black rounded-xl hover:shadow-xl transition-all duration-300 bg-white hover:scale-[1.02]">
        <div class="text-sm text-gray-500">Requests · Review</div>
        <div id="reqReview" class="text-xl font-semibold">—</div>
      </div>
      <div class="p-4 border border-black rounded-xl hover:shadow-xl transition-all duration-300 bg-white hover:scale-[1.02]">
        <div class="text-sm text-gray-500">Requests · Pending</div>
        <div id="reqPending" class="text-xl font-semibold">—</div>
      </div>
      <div class="p-4 border border-black rounded-xl hover:shadow-xl transition-all duration-300 bg-white hover:scale-[1.02]">
        <div class="text-sm text-gray-500">Requests · Rejected</div>
        <div id="reqRejected" class="text-xl font-semibold">—</div>
      </div>
      <div class="p-4 border border-black rounded-xl hover:shadow-xl transition-all duration-300 bg-white hover:scale-[1.02]">
        <div class="text-sm text-gray-500">Requests · Active</div>
        <div id="reqActive" class="text-xl font-semibold">—</div>
      </div>
      <div class="p-4 border border-black rounded-xl hover:shadow-xl transition-all duration-300 bg-white hover:scale-[1.02]">
        <div class="text-sm text-gray-500">Requests · Completed</div>
        <div id="reqComplete" class="text-xl font-semibold">—</div>
      </div>
    </section>

    
    <section class="flex flex-wrap items-center gap-2">
      <div class="flex items-center gap-2">
        <label for="fromDate" class="text-sm text-gray-600">From</label>
        <input id="fromDate" type="date" placeholder="dd/mm/yyyy" class="border rounded-md px-3 py-2" />
      </div>
      <div class="flex items-center gap-2">
        <label for="toDate" class="text-sm text-gray-600">To</label>
        <input id="toDate" type="date" placeholder="dd/mm/yyyy" class="border rounded-md px-3 py-2" />
      </div>
      <select id="granularity" class="border rounded-md px-3 py-2">
        <option value="day">Day</option>
        <option value="week">Week</option>
        <option value="month" selected>Month</option>
        <option value="year">Year</option>
      </select>
      <button id="applyBtn" class="px-3 py-2 rounded-md bg-gray-900 text-white hover:bg-gray-800">Apply</button>
      <button id="resetBtn" class="px-3 py-2 rounded-md border hover:bg-gray-100">Reset</button>
    </section>

    <!-- Single, centered chart -->
    <section class="grid grid-cols-1">
      <div class="p-4 rounded-xl bg-white shadow-sm max-w-3xl mx-auto w-full">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <h2 class="font-semibold">Requests by Status</h2>
            <span id="seriesRange" class="text-xs text-gray-500 hidden"></span>
          </div>
          <div class="ext-right hidden">
            <div class="text-[10px] text-gray-500">API:</div>
            <div class="text-[11px]">
              <code id="apiCall" class="api">GET /api/admin/metrics/</code> 
            </div>
          </div>
        </div>
        <div id="requestsChartWrap" class="mt-3 relative">
          <canvas id="requestsChart"></canvas>
        </div>
      </div>
    </section>
  </main>

  <script>
    // UI
    function qs(sel){ return document.querySelector(sel); }
    function buildQuery(params){
      const pairs = Object.entries(params).filter(([_,v]) => v !== undefined && v !== null && v !== "");
      if (!pairs.length) return "";
      return "?" + pairs.map(([k,v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&");
    }

    // controls
    const fromInput = qs("#fromDate");
    const toInput   = qs("#toDate");
    const granSel   = qs("#granularity");
    const applyBtn  = qs("#applyBtn");
    const resetBtn  = qs("#resetBtn");
    const exportLink= qs("#exportLink");

    let requestsChart;

    /*ASYNC BOUNDARY FUNCTION: fetchJSON(url) */
    async function fetchJSON(url){
      const resp = await fetch(url, { credentials: "include" });
      if (!resp.ok) throw new Error("HTTP "+resp.status);
      return resp.json();
    }

    /* ASYNC BOUNDARY FUNCTION: loadWhoAmI()*/
    async function loadWhoAmI(){
      try{
        const me = await fetchJSON("/api/auth/me/"); // Boundary call
        qs("#whoami").textContent = `Logged in as ${me.username} (${me.role})`;
      }catch(e){
        location.href = "/login/?next=/pa_dashboard/";
      }
    }

    // UI Helpers
    function updateApiLabel(fullUrl){
      try{
        const u = new URL(fullUrl, window.location.origin);
        qs("#apiCall").textContent = `${u.pathname}${u.search}`;
      }catch{
        qs("#apiCall").textContent = fullUrl;
      }
    }


    function buildExportLink(){
      const query = buildQuery({ from: fromInput.value, to: toInput.value });
      exportLink.href = `/api/admin/reports/requests.csv${query}`;
      exportLink.title = `GET ${exportLink.href}`;
    }

    function ensureRequestsChart(ctx, data, options){
      if (requestsChart) requestsChart.destroy();
      requestsChart = new Chart(ctx, { type: "bar", data, options });
    }

    function mapCardsToUI(cards){
     
      qs("#kpiPins").textContent          = cards["Number of PIN"] ?? "0";
      qs("#kpiCVs").textContent           = cards["Number of CV"] ?? "0";
      qs("#kpiCSRs").textContent          = cards["Number of CSR"] ?? "0";
      qs("#kpiOpenFlags").textContent     = cards["Open Flags"] ?? "0";
      qs("#kpiResolvedFlags").textContent = cards["Resolved Flags"] ?? "0";

      qs("#reqReview").textContent   = cards["Review"] ?? "0";
      qs("#reqPending").textContent  = cards["Pending"] ?? "0";
      qs("#reqRejected").textContent = cards["Rejected"] ?? "0";
      qs("#reqActive").textContent   = cards["Active"] ?? "0";
      qs("#reqComplete").textContent = cards["Completed"] ?? "0";
    }

    /* ASYNC BOUNDARY FUNCTION: loadMetrics() */
    async function loadMetrics(){
      const params = {
        granularity: granSel.value || "day",
        from: fromInput.value,
        to: toInput.value,
      };
      const query = buildQuery(params);
      const url = `/api/admin/metrics/${query}`;
      updateApiLabel(url);

      // Boundary: fetch metrics
      const data = await fetchJSON(url);

      // Cards
      mapCardsToUI(data.cards || {});

      // Chart series + range
      const series = (data.charts && data.charts.requests_by_status) ? data.charts.requests_by_status : [];
      const range  = (data.charts && data.charts.range) ? data.charts.range : null;
      qs("#seriesRange").textContent = range ? `${range.from} → ${range.to}` : "";

      const labels   = series.map(r => r.date);
      const review   = series.map(r => r.review);
      const pending  = series.map(r => r.pending);
      const rejected = series.map(r => r.rejected ?? 0);
      const active   = series.map(r => r.active);
      const complete = series.map(r => r.complete);

      ensureRequestsChart(
        document.getElementById("requestsChart").getContext("2d"),
        {
          labels,
          datasets: [
            { label: "Review",    data: review },
            { label: "Pending",   data: pending },
            { label: "Rejected",  data: rejected },
            { label: "Active",    data: active },
            { label: "Completed", data: complete },
          ]
        },
        {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          scales: {
            x: { stacked: false, ticks: { autoSkip: true, maxRotation: 0 } },
            y: { beginAtZero: true, precision: 0 }
          },
          plugins: {
            legend: { position: "bottom" },
            tooltip: { callbacks: { footer: (items) => {
              const lab = qs("#apiCall").textContent;
              return `Source: ${lab}`;
            }}}
          }
        }
      );

      buildExportLink();
    }

    /* Resets UI inputs, then triggers Boundary (loadMetrics)= */
    function resetFilters(){
      fromInput.value = "";
      toInput.value   = "";
      granSel.value   = "day";
      loadMetrics(); // Boundary
    }

    // Wire UI 
    applyBtn.addEventListener("click", loadMetrics); // Boundary
    resetBtn.addEventListener("click", resetFilters);


    window.addEventListener("DOMContentLoaded", async () => {
      await loadWhoAmI();  // Boundary
      buildExportLink();   // UI
      await loadMetrics(); // Boundary
    });
  </script>
</body>
</html>
