<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CSR · Requests · Helping Hands</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .table{width:100%;border-collapse:collapse}
    .table th{ text-align:left; font-weight:600; font-size:.8rem; color:#6b7280; padding:.5rem .75rem }
    .table td{ padding:.6rem .75rem; border-top:1px solid #eee }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-50 border-b bg-white/90 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/csr_dashboard/" class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21S4 13.748 4 9A5 5 0 0 1 14 7a5 5 0 1 1 6 2c0 4.748-8 12-8 12z"/></svg>
        <span class="text-xl font-bold">Helping Hands (CSR)</span>
      </a>
      <nav class="flex items-center gap-3">
        <a href="/csr_requests/" class="px-3 py-1.5 rounded-md bg-gray-900 text-white">Requests</a>
        <a href="/csr_shortlist/" class="px-3 py-1.5 rounded-md border hover:bg-gray-100">Shortlist</a>
        <a href="/csr_match/" class="px-3 py-1.5 rounded-md border hover:bg-gray-100">Match</a>
        <a href="/csr_claims/" class="px-3 py-1.5 rounded-md border hover:bg-gray-100">Claims</a>
        <form method="post" action="/api/auth/logout/" class="inline-block m-0 p-0">
          {% csrf_token %}
          <button type="submit" class="px-3 py-1.5 rounded-md bg-red-500 text-white hover:bg-red-600">
            Log out
          </button>
        </form>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <h1 class="text-2xl font-bold">Request Pool</h1>

    <section class="p-4 rounded-xl bg-white border">
      <h2 class="font-semibold mb-2">Appointment Dates Coming Soon</h2>
      <table class="table">
        <thead><tr><th>ID</th><th>Category</th><th>Date</th><th>Location</th><th>Shortlists</th><th></th></tr></thead>
        <tbody data-table="comingSoon"></tbody>
      </table>
    </section>

    <section class="p-4 rounded-xl bg-white border">
      <h2 class="font-semibold mb-2">All Requests</h2>
      <table class="table">
        <thead><tr><th>ID</th><th>Category</th><th>Date</th><th>Location</th><th>Shortlists</th><th></th></tr></thead>
        <tbody data-table="allRequests"></tbody>
      </table>
    </section>
  </main>

  <script>
    const qs = (sel, root=document) => root.querySelector(sel);
    const qsa = (sel, root=document) => [...root.querySelectorAll(sel)];
    const getCSRF = () => document.cookie.split("; ").find(c=>c.startsWith("csrftoken="))?.split("=")[1];

    async function fetchJSON(url, opts={}) {
      const resp = await fetch(url, { credentials:"include", headers:{ "X-CSRFToken": getCSRF(), "Content-Type":"application/json" }, ...opts });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.json();
    }

    function rowHTML(r){
      return `
        <tr class="hover:bg-gray-50">
          <td class="font-mono">${r.id}</td>
          <td>${r.category}</td>
          <td>${r.appointment_date}</td>
          <td>${r.location}</td>
          <td>${r.shortlist_count ?? 0}</td>
          <td class="space-x-2">
            <button class="px-2 py-1 border rounded-md" data-action="shortlist" data-id="${r.id}">Shortlist</button>
            <button class="px-2 py-1 bg-gray-900 text-white rounded-md" data-action="commit" data-id="${r.id}">Commit</button>
          </td>
        </tr>
      `;
    }

    function wireRowActions(root){
      root.addEventListener("click", async (e) => {
        const btn = e.target.closest("button");
        if(!btn) return;
        const id = btn.getAttribute("data-id");
        const action = btn.getAttribute("data-action");

        if (action === "shortlist") {
          await shortlistRequest(id);
        } else if (action === "commit") {
          await commitRequest(id);
        }
        await loadCSRRequestPool(); // refresh lists
      });
    }

    async function shortlistRequest(requestId){
      await fetchJSON(`/api/csr/requests/${encodeURIComponent(requestId)}/shortlist/`, { method:"POST", body:"{}" });
    }

    async function commitRequest(requestId){
      await fetchJSON(`/api/csr/requests/${encodeURIComponent(requestId)}/commit/`, { method:"POST", body:"{}" });
    }

    function renderComingSoon(rows){
      const body = qs('[data-table="comingSoon"]');
      body.innerHTML = rows.map(rowHTML).join("");
      wireRowActions(body);
    }

    function renderAllRequests(rows){
      const body = qs('[data-table="allRequests"]');
      body.innerHTML = rows.map(rowHTML).join("");
      wireRowActions(body);
    }

    async function loadCSRRequestPool(){
      const data = await fetchJSON("/api/csr/requests/");
      renderComingSoon(data.coming_soon || []);
      renderAllRequests(data.all_requests || []);
    }

    window.addEventListener("DOMContentLoaded", async () => {
      await loadCSRRequestPool();
    });
  </script>
</body>
</html>
