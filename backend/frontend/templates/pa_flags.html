<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Flagged Requests · Helping Hands</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <!-- Top Bar -->
  <header class="sticky top-0 z-50 border-b bg-white/90 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/pa_dashboard/" class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 21S4 13.748 4 9A5 5 0 0 1 14 7a5 5 0 1 1 6 2c0 4.748-8 12-8 12z"/>
        </svg>
        <span class="text-xl font-bold">Helping Hands · Flags</span>
      </a>
      <nav class="flex items-center gap-3">
        <a href="/pa_dashboard/" class="px-3 py-1.5 rounded-md border hover:bg-gray-100">Dashboard</a>
        <form method="post" action="/api/auth/logout/">
          {% csrf_token %}
          <button class="px-3 py-1.5 rounded-md bg-red-500 text-white hover:bg-red-600">Log out</button>
        </form>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-6">
    <h1 class="text-2xl font-bold">Flagged Requests</h1>

    <!-- Filters -->
    <div class="flex flex-wrap items-center gap-2">
      <select id="resolved" class="border rounded-md px-3 py-2">
        <option value="">All</option>
        <option value="false">Open</option>
        <option value="true">Resolved</option>
      </select>
      <select id="ftype" class="border rounded-md px-3 py-2">
        <option value="">Any type</option>
        <option value="auto">Auto</option>
        <option value="manual">Manual</option>
      </select>
      <input id="fromDate" type="date" class="border rounded-md px-3 py-2" />
      <input id="toDate" type="date" class="border rounded-md px-3 py-2" />
      <button id="applyBtn" class="px-3 py-2 rounded-md bg-gray-900 text-white hover:bg-gray-800">Apply</button>
    </div>

    <!-- Table -->
    <div class="rounded-xl border bg-white overflow-x-auto">
      <table class="w-full text-left text-sm">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="px-3 py-2">ID</th>
            <th class="px-3 py-2">Type</th>
            <th class="px-3 py-2">Request</th>
            <th class="px-3 py-2">CSR</th>
            <th class="px-3 py-2">Reason</th>
            <th class="px-3 py-2">Created</th>
            <th class="px-3 py-2">Status</th>
            <th class="px-3 py-2"></th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <p id="status" class="text-sm text-gray-500"></p>
  </main>

  <!-- Decision Modal -->
  <div id="modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative max-w-md mx-auto mt-24 bg-white rounded-xl shadow-lg overflow-hidden">
      <div class="px-5 py-4 border-b flex items-center justify-between">
        <h3 class="font-semibold">Resolve Flag</h3>
        <button id="modalClose" class="text-gray-500 hover:text-gray-700">&times;</button>
      </div>
      <div class="p-5 space-y-4">
        <div class="text-sm text-gray-600">
          Flag <code id="modalFlagId" class="px-1.5 py-0.5 bg-gray-100 rounded text-gray-800"></code>
          for Request <code id="modalReqId" class="px-1.5 py-0.5 bg-gray-100 rounded text-gray-800"></code>
        </div>

        <div class="space-y-2">
          <div class="text-sm font-medium">Decision</div>
          <div class="flex items-center gap-4">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="decision" value="accept" class="decision" checked>
              <span>Accept</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="decision" value="reject" class="decision">
              <span>Reject</span>
            </label>
          </div>
          <p class="text-xs text-gray-500">Accept = flag valid (request continues). Reject = flag invalid (request rejected). Notes required for reject.</p>
        </div>

        <div>
          <label for="modalNotes" class="text-sm font-medium">Resolution notes</label>
          <textarea id="modalNotes" rows="4" class="mt-1 w-full border rounded-md p-2"
            placeholder="Add any context for your decision…"></textarea>
          <p id="notesHint" class="text-xs text-gray-500 mt-1">Optional for Accept. Required for Reject.</p>
        </div>

        <div id="modalError" class="hidden text-sm text-red-600"></div>
      </div>
      <div class="px-5 py-4 bg-gray-50 border-t flex items-center justify-end gap-2">
        <button id="modalCancel" class="px-3 py-2 rounded-md border hover:bg-gray-100">Cancel</button>
        <button id="modalSubmit" class="px-3 py-2 rounded-md bg-gray-900 text-white hover:bg-gray-800">Resolve</button>
      </div>
    </div>
  </div>

  <script>
    // ---- CSRF ----
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    // ---- Elements ---
    const fromInput   = document.getElementById("fromDate");
    const toInput     = document.getElementById("toDate");
    const resolvedSel = document.getElementById("resolved");
    const ftypeSel    = document.getElementById("ftype");
    const applyBtn    = document.getElementById("applyBtn");
    const rows        = document.getElementById("rows");
    const statusLine  = document.getElementById("status");


    const modal       = document.getElementById("modal");
    const modalClose  = document.getElementById("modalClose");
    const modalCancel = document.getElementById("modalCancel");
    const modalSubmit = document.getElementById("modalSubmit");
    const modalNotes  = document.getElementById("modalNotes");
    const modalFlagId = document.getElementById("modalFlagId");
    const modalReqId  = document.getElementById("modalReqId");
    const modalError  = document.getElementById("modalError");

    let activeFlagId = null;

 
    function fmtDate(d){ return d.toISOString().slice(0,10); }
    function daysAgo(n){ const d=new Date(); d.setDate(d.getDate()-n); return d; }
    fromInput.value = fmtDate(daysAgo(30));
    toInput.value   = fmtDate(new Date());

    /* ===============================
       ASYNC BOUNDARY FUNCTION: fetchJSON(url)
    =================================== */
    async function fetchJSON(url){
      const r = await fetch(url, { credentials: "include" });
      if (!r.ok) throw new Error("HTTP "+r.status);
      return r.json();
    }

 
    function openModal(flag){
      activeFlagId = flag.id;
      modalFlagId.textContent = flag.id;
      modalReqId.textContent  = flag.request_id ?? "-";
      modalNotes.value = "";
      modalError.classList.add("hidden");


      document.querySelectorAll('input.decision[value="accept"]')[0].checked = true; 
      modal.classList.remove("hidden");
    }
    function closeModal(){
      modal.classList.add("hidden");
      activeFlagId = null;
    }

    /* ==================
       BOUNDARY FUNCTION: load()
    ======================= */
    async function load(){
      const params = new URLSearchParams();
      if (resolvedSel.value) params.set("resolved", resolvedSel.value);
      if (ftypeSel.value)    params.set("flag_type", ftypeSel.value);
      if (fromInput.value)   params.set("from", fromInput.value);
      if (toInput.value)     params.set("to", toInput.value);

      const url = "/api/admin/flags/?" + params.toString();
      const data = await fetchJSON(url); 

      rows.innerHTML = "";
      (data || []).forEach(f => {
        const tr = document.createElement("tr");
        tr.className = "border-t";
        const reason = f.reasonbycsr ?? f.reason ?? "";
        const created = f.created_at ? f.created_at.slice(0,19).replace("T"," ") : "";
        const requestStatus = f.request_status ?? "";
        const serviceType = f.service_type ?? "";
        const csrName = f.csr_name ?? f.csr ?? "-";

        tr.innerHTML = `
          <td class="px-3 py-2">${f.id}</td>
          <td class="px-3 py-2 capitalize">${f.flag_type}</td>
          <td class="px-3 py-2">
            <div class="text-sm font-medium">${f.request_id ?? "-"}</div>
            <div class="text-xs text-gray-500">${requestStatus}${requestStatus && serviceType ? " • " : ""}${serviceType}</div>
          </td>
          <td class="px-3 py-2">${csrName}</td>
          <td class="px-3 py-2">${reason}</td>
          <td class="px-3 py-2">${created}</td>
          <td class="px-3 py-2">${f.resolved ? "Resolved" : "Open"}</td>
          <td class="px-3 py-2 text-right">
            ${f.resolved
              ? ""
              : `<button data-id="${f.id}" class="edit px-3 py-1.5 rounded-md bg-blue-600 text-white hover:bg-blue-700">Edit</button>`}
          </td>
        `;
        rows.appendChild(tr);
      });

      statusLine.textContent = `Loaded ${data?.length || 0} flags`;

      // Wire each "Edit" to open modal 
      document.querySelectorAll("button.edit").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-id");
          const flag = (data || []).find(x => String(x.id) === String(id));
          if (!flag) return;
          openModal(flag);
        });
      });
    }

    /* ===========================================
       ASYNC BOUNDARY FUNCTION: submitDecision()
    ============================================== */
    async function submitDecision(){
      if (!activeFlagId) return;
      const decision = document.querySelector('input[name="decision"]:checked')?.value || "accept";
      const notes = modalNotes.value.trim();

      if (decision === "reject" && !notes){
        modalError.textContent = "Notes are required to reject.";
        modalError.classList.remove("hidden");
        return;
      }

      const endpoint = decision === "accept"
        ? `/api/admin/flags/${activeFlagId}/accept/`
        : `/api/admin/flags/${activeFlagId}/reject/`;

      try{
 
        const resp = await fetch(endpoint, {
          method: "POST",
          credentials: "include",
          headers: {
            "X-CSRFToken": csrftoken,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ resolution_notes: notes })
        });
        if (!resp.ok){
          const t = await resp.text();
          throw new Error(`HTTP ${resp.status}: ${t || "Failed to resolve flag."}`);
        }
        await load();
        closeModal();
      }catch(err){
        console.error(err);
        modalError.textContent = err.message || "Something went wrong.";
        modalError.classList.remove("hidden");
      }
    }
    

    function bindFilters(){
      [resolvedSel, ftypeSel].forEach(el => el.addEventListener("change", load));
      [fromInput, toInput].forEach(el => el.addEventListener("change", () => {
        if (fromInput.value && toInput.value && fromInput.value > toInput.value){
          statusLine.textContent = "From date must be before To date.";
          return;
        }
        load();
      }));
      applyBtn.addEventListener("click", (e) => {
        e.preventDefault();
        load();
      });
    }
    function bindModalControls(){
      const hide = () => closeModal();
      modalClose.addEventListener("click", hide);
      modalCancel.addEventListener("click", hide);
      modalSubmit.addEventListener("click", submitDecision);
      modal.addEventListener("click", (e) => {
        if (e.target === modal) hide();
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !modal.classList.contains("hidden")){ 
          hide();
        }
      });
    }
    async function init(){
      bindFilters();
      bindModalControls();
      statusLine.textContent = "Loading flags…";
      try{
        await load();
      }catch(err){
        console.error(err);
        statusLine.textContent = "Failed to load flags.";
      }
    }
    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>