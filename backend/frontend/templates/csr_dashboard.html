<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CSR · Dashboard · Helping Hands</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    #requestsChartWrap { height: 22rem; }
    #requestsChart { width: 100% !important; height: 100% !important; }
    code.api { font-size: 0.75rem; padding: 0.15rem 0.35rem; background: #f3f4f6; border-radius: 0.25rem; }
    .table{width:100%;border-collapse:collapse}
    .table th{ text-align:left; font-weight:600; font-size:.8rem; color:#6b7280; padding:.5rem .75rem }
    .table td{ padding:.6rem .75rem; border-top:1px solid #eee }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <!-- Top Bar -->
  <header class="sticky top-0 z-50 border-b bg-white/90 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/csr_dashboard/" class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-red-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 21S4 13.748 4 9A5 5 0 0 1 14 7a5 5 0 1 1 6 2c0 4.748-8 12-8 12z"/>
        </svg>
        <span class="text-xl font-bold">Helping Hands (CSR)</span>
      </a>
      <nav class="flex items-center gap-3">
        <button id="enableDesktopAlerts"
          class="px-3 py-1.5 rounded-md border hover:bg-gray-100"
          type="button">
          Enable alerts
        </button>
        <a href="/csr_requests/" class="px-3 py-1.5 rounded-md border hover:bg-gray-100">Requests</a>
        <a href="/csr_shortlist/" class="px-3 py-1.5 rounded-md border hover:bg-gray-100">Shortlist</a>
        <a href="/csr_match/" class="px-3 py-1.5 rounded-md border hover:bg-gray-100">Match</a>
        <a href="/csr_claims/" class="px-3 py-1.5 rounded-md border hover:bg-gray-100">Claims</a>
        <form method="post" action="/api/auth/logout/" class="inline-block m-0 p-0">
          {% csrf_token %}
          <button type="submit" class="px-3 py-1.5 rounded-md bg-red-500 text-white hover:bg-red-600">
            Log out
          </button>
        </form>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <section class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold">CSR Dashboard</h1>
        <p class="text-gray-600" id="whoami">Checking session…</p>
      </div>
    </section>

    <!-- Today active + committed -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="p-4 rounded-xl bg-white border">
        <h2 class="font-semibold mb-2">Today’s Active</h2>
        <table class="table">
          <thead><tr><th>ID</th><th>PIN</th><th>CV</th><th>Type</th><th>Time</th></tr></thead>
          <tbody data-table="todayActive"></tbody>
        </table>
      </div>
      <div class="p-4 rounded-xl bg-white border">
        <h2 class="font-semibold mb-2">My Committed Requests</h2>
        <table class="table">
          <thead><tr><th>ID</th><th>PIN</th><th>Type</th><th>Status</th><th></th></tr></thead>
          <tbody data-table="committedRows"></tbody>
        </table>
      </div>
    </section>

    <!-- Notifications panel -->
    <section class="p-4 rounded-xl bg-white border">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold">Notifications</h2>
        <span class="text-xs text-gray-500" id="apiLabel"></span>
      </div>
      <ul class="mt-2 space-y-2" data-list="notifications"></ul>
    </section>
  </main>

  <script>
    
    const qs = (sel, root=document) => root.querySelector(sel);
    const qsa = (sel, root=document) => [...root.querySelectorAll(sel)];
    const getCSRF = () => document.cookie.split("; ").find(c=>c.startsWith("csrftoken="))?.split("=")[1];

    async function fetchJSON(url, opts={}) {
      const baseHeaders = { "X-CSRFToken": getCSRF(), "Content-Type":"application/json" };
      const resp = await fetch(url, {
        cache: "no-store",
        credentials:"include",
        headers:{ ...baseHeaders, ...(opts.headers || {}) },
        ...opts
      });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return resp.json();
    }

    const DASHBOARD_REFRESH_MS = 15000; // 15s auto refresh for dashboard and notifications
    let dashboardTimer = null;

    const formatTime = (value) => {
      if (!value) return "-";
      try {
        const date = value.includes("T") ? new Date(value) : new Date(`1970-01-01T${value}`);
        return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      } catch {
        return value;
      }
    };

    const formatType = (item) => item?.service_type ?? item?.category ?? "-";

    // ---------- page logic ----------
    async function loadWhoAmI() {
      try {
        const me = await fetchJSON("/api/auth/me/");
        qs("#whoami").textContent = `Logged in as ${me.username} (CSR)`;
      } catch {
        location.href = "/login/?next=/csr_dashboard/";
      }
    }

    function renderTodayActive(rows){
      const body = qs('[data-table="todayActive"]');
      body.innerHTML = rows.map(r => `
        <tr class="hover:bg-gray-50">
          <td class="font-mono">${r.id}</td>
          <td>${r.pin}</td>
          <td>${r.cv ?? "-"}</td>
          <td>${formatType(r)}</td>
          <td>${formatTime(r.appointment_time)}</td>
        </tr>
      `).join("");
    }

    function renderCommitted(rows){
      const body = qs('[data-table="committedRows"]');
      body.innerHTML = rows.map(r => `
        <tr class="hover:bg-gray-50">
          <td class="font-mono">${r.id}</td>
          <td>${r.pin}</td>
          <td>${formatType(r)}</td>
          <td><span class="px-2 py-0.5 rounded-full text-xs border">${r.status}</span></td>
          <td><a class="text-blue-600 hover:underline" href="/csr_match_detail/${encodeURIComponent(r.id)}/">Open</a></td>
        </tr>
      `).join("");
    }


    // this is to render notifications fetched from the API will be used in loadCSRNotifications()
    // adds each notification as a list item in the notifications section like a row 
    //basically for the notifications section in the dashboard
    function renderNotifications(items){
      const list = qs('[data-list="notifications"]');
      list.innerHTML = items.map(n => `
        <li class="p-3 border rounded-lg flex items-center justify-between">
          <div>
            <div class="text-sm font-medium">${n.type.replaceAll("_"," ").toUpperCase()}</div>
            <div class="text-sm text-gray-700">${n.message}</div>
          </div>
          <div class="text-xs text-gray-400">${new Date(n.created_at).toLocaleString()}</div> 
        </li>
      `).join("");
      qs("#apiLabel").style.display = "none";
    }

    async function loadCSRDashboard(){
      const data = await fetchJSON("/api/csr/dashboard/");
      renderTodayActive(data.today_active || []);
      renderCommitted(data.committed || []);
    }


    // load notifications, basically for the notifications section in the dashboard
    async function loadCSRNotifications(){
      const data = await fetchJSON("/api/csr/notifications/");
      const items = Array.isArray(data) ? data : data.items || [];
      renderNotifications(items);
    }

    
    function startDashboardAutoRefresh(){
      if (dashboardTimer) clearInterval(dashboardTimer);
      dashboardTimer = setInterval(() => {
        loadCSRDashboard().catch(err => console.warn("Dashboard refresh failed:", err));
        loadCSRNotifications().catch(err => console.warn("Notification refresh failed:", err));
      }, DASHBOARD_REFRESH_MS);
    }

    // init
    window.addEventListener("DOMContentLoaded", async () => {
      await loadWhoAmI();
      try {
        await Promise.all([
          loadCSRDashboard(),
          loadCSRNotifications(),
        ]);
      } catch (err) {
        console.warn("Initial dashboard load failed:", err);
      }
      startDashboardAutoRefresh();
    });

   

    const Notifs = {
        enabled: false,
        lastSeenId: 0,                 
        pollMs: 30000,                
        timer: null
      };

      // Request browser permission for desktop notifications
      async function requestDesktopPermission() {
        if (!("Notification" in window)) {
          alert("Notifications not supported in this browser.");
          return false;
        }
        
        if (Notification.permission === "granted") return true;
        if (Notification.permission === "denied") {
          alert("You previously blocked notifications. Please enable them in browser settings."); // If denied inform us to change setting
          return false;
        }

        //Ask the browser for permission to show desktop notifications and wait until the user chooses allow block
        const perm = await Notification.requestPermission();
        return perm === "granted";
      }

      function showBrowserNotification({ title, body, tag, data }) {
        try {
          const n = new Notification(title, {
            body,
            tag,                
            icon: "/static/favicon.ico" 
           
          });
          n.onclick = (evt) => {
            window.focus();
            
            n.close();
          };
        } catch (e) {
         
          console.warn("Notification failed:", e);
        }
      }

     
      async function pollCSRNotifications() {
        if (!Notifs.enabled) return;

        try {
          const resp = await fetch("/api/csr/notifications/", {
            credentials: "include",
            cache: "no-store"
          });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

          
          const raw = await resp.json();
          const items = Array.isArray(raw) ? raw : (raw.items || []);
          if (!items.length) return;

          // sort by id (oldest to newest)
          items.sort((a, b) => (a.id || 0) - (b.id || 0));
          const newestId = items[items.length - 1].id || 0;

          // First run after enabling alerts
          // just record the latest id so we don't popup alld of old notifications
          if (!Notifs.lastSeenId && newestId) {
            Notifs.lastSeenId = newestId;
            return;
          }

          // Only notifications that are newer than what i have  seen
          const fresh = items.filter(n => (n.id || 0) > (Notifs.lastSeenId || 0));
          if (!fresh.length) return;

          for (const n of fresh) {
            const title = ({
              "offer_sent":      "Offer sent",
              "offer_declined":  "CV declined",
              "offer_expired":   "Offer expired",
              "queue_advanced":  "Moved to next CV",
              "match_accepted":  "Match accepted",
              "match_filled":    "Queue filled",
            })[n.type] || "Update";

            const body = n.message || "New update.";

            showBrowserNotification({
              title,
              body,
              tag: `csr-${n.type}-${n.request_id || "none"}`,
              data: { request_id: n.request_id, cv_id: n.cv_id }
            });

            // move the "last seen" marker forward
            if ((n.id || 0) > (Notifs.lastSeenId || 0)) {
              Notifs.lastSeenId = n.id;
            }
          }
        } catch (e) {
          console.warn("Notification poll failed:", e);
        }
      }


      function startNotificationPolling() {
        if (Notifs.timer) clearInterval(Notifs.timer);
        Notifs.timer = setInterval(pollCSRNotifications, Notifs.pollMs);

        pollCSRNotifications();
      }


      document.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("enableDesktopAlerts");
        if (!btn) return;


        function refreshBtn() {
          btn.textContent = Notifs.enabled ? "Desktop alerts ON" : "Enable alerts";
          btn.classList.toggle("bg-gray-900", Notifs.enabled);
          btn.classList.toggle("text-white", Notifs.enabled);
          btn.classList.toggle("border", !Notifs.enabled);
        }
        refreshBtn();
        if (Notification.permission === "granted") {
          Notifs.enabled = true;
          refreshBtn();
          startNotificationPolling();
        }

        btn.addEventListener("click", async () => {
          const ok = await requestDesktopPermission();
          if (!ok) return;
          Notifs.enabled = true;
          refreshBtn();
          startNotificationPolling();
        });
      });


      // Refresh dashboard and notifications when tab becomes visible
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
          loadCSRDashboard().catch(err => console.warn("Dashboard refresh failed:", err));
          loadCSRNotifications().catch(err => console.warn("Notification refresh failed:", err));
          if (Notifs.enabled) {
            pollCSRNotifications();
          }
        }
      });
    </script>
</body>
</html>
