<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CSR · Dashboard · Helping Hands</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .table{width:100%;border-collapse:collapse}
    .table th{ text-align:left; font-weight:600; font-size:.8rem; color:#6b7280; padding:.5rem .75rem }
    .table td{ padding:.6rem .75rem; border-top:1px solid #eee }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-50 border-b bg-white/90 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/csr_dashboard/" class="text-xl font-bold">Helping Hands (CSR)</a>
      <nav class="flex items-center gap-2">
        <a href="/csr_requests/" class="px-3 py-1.5 rounded-md border">Requests</a>
        <a href="/csr_shortlisted/" class="px-3 py-1.5 rounded-md border">Shortlisted</a>
        <a href="/csr_matching/" class="px-3 py-1.5 rounded-md border">Matching</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
    <h1 class="text-2xl font-bold">Jane’s Dashboard</h1>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Ongoing -->
      <div class="lg:col-span-2 rounded-2xl border bg-white p-4">
        <h2 class="font-semibold mb-2">Ongoing Volunteering Services</h2>
        <div class="overflow-x-auto">
          <table class="table">
            <thead><tr><th>Request ID</th><th>PIN Name</th><th>Volunteer</th><th>Date &amp; Time</th></tr></thead>
            <tbody id="ongoing"><tr><td class="py-3 text-gray-500" colspan="4">Loading…</td></tr></tbody>
          </table>
        </div>
      </div>
      <!-- Notifications -->
      <div class="rounded-2xl border bg-white p-4">
        <h2 class="font-semibold mb-2">Notification</h2>
        <div id="notif" class="space-y-3 text-sm">
          <div class="text-gray-500">Loading…</div>
        </div>
      </div>
    </section>

    <!-- Matching status -->
    <section class="rounded-2xl border bg-white p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Matching Status</h2>
        <input id="q" placeholder="Search …" class="border rounded-md px-3 py-2 w-64" />
      </div>
      <div class="overflow-x-auto">
        <table class="table">
          <thead><tr><th>Request ID</th><th>PIN</th><th>Status</th></tr></thead>
          <tbody id="matchBody"><tr><td class="py-3 text-gray-500" colspan="3">Loading…</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- script for functions -->
  <script>
    async function jget(u){ const r=await fetch(u,{credentials:"include"}); if(!r.ok) throw new Error(r.status); return r.json(); }
    const ongoing = document.getElementById("ongoing");
    const notif = document.getElementById("notif");
    const matchBody = document.getElementById("matchBody");
    const q = document.getElementById("q");

    let MATCH=[];

    async function loadOngoing(){
      // Active requests for this CSR’s company (simplify: use CV side endpoint or admin filter if you have)
      const data = await jget("/api/csr/requests/pending/"); // reuse then filter active via separate call if needed
      // In your API you may have a CSR “active” endpoint; adjust if present.
      const active = (await jget("/api/cv/requests/")).filter(r=> r.status==="active"); // fallback if CV endpoint present
      ongoing.innerHTML = active.length ? active.map(r=>`
        <tr><td>${r.id}</td><td>${(r.pin_name||r.pin||"")}</td><td>${(r.cv_name||r.cv||"")}</td>
        <td>${r.appointment_date||""} ${(r.appointment_time||"").slice(0,5)}</td></tr>`).join("")
        : `<tr><td class="py-3 text-gray-500" colspan="4">No ongoing services.</td></tr>`;
    }

    async function loadNotifications(){
      try{
        const items = await jget("/api/me/notifications/");
        notif.innerHTML = items.length ? items.map(n=>`
          <div>
            <div class="font-semibold">${n.title || (n.type==="match_declined"?"Declined new requests":"Update")}</div>
            <div>Request ${n.request_id||""} ${n.message||""}</div>
            <div class="text-xs text-gray-500">${(n.created_at||"").replace("T"," ").slice(0,16)}</div>
          </div>
        `).join("") : `<div class="text-gray-500">No notifications.</div>`;
      }catch{
        notif.innerHTML = `<div class="text-gray-500">Notification API unavailable.</div>`;
      }
    }

    async function loadMatching(){
      // Show queue state per request if available
      // You can back this with a small CSR endpoint; here we derive from pending + queue
      const pending = await jget("/api/csr/requests/pending/");
      // If you’ve got a dedicated status endpoint, swap it in:
      MATCH = pending.map(r=>({ id:r.id, pin:(r.pin_name||""), status:(r.queue_status||"Waiting")})); 
      drawMatch(MATCH);
    }
    function drawMatch(arr){
      const s=(q.value||"").toLowerCase();
      const L = s ? arr.filter(x=>`${x.id} ${x.pin} ${x.status}`.toLowerCase().includes(s)) : arr;
      matchBody.innerHTML = L.length ? L.map(x=>`<tr><td>${x.id}</td><td>${x.pin||"-"}</td><td>${x.status}</td></tr>`).join("")
        : `<tr><td class="py-3 text-gray-500" colspan="3">No rows.</td></tr>`;
    }
    q.addEventListener("input",()=>drawMatch(MATCH));

    window.addEventListener("DOMContentLoaded", async ()=>{
      await Promise.all([loadOngoing(), loadNotifications(), loadMatching()]);
    });
  </script>
</body>
</html>
